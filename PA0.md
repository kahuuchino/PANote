# PA0 ubuntu安装与试水  

我是已经有了ubuntu使用经验，能比较流畅的使用gcc进行单文件编译，因此遇到的问题不是很多。  
- - -
## 版本是个坑
ics2022讲义中要求使用的是ubuntu21.04，这个版本其实是个大坑，你在网上基本没见过用这个发行版的，清华的软件源也没有这个版本的镜像，直接给你弄个20.04和22.04，一点脾气都没有。  
将就着用吧，也不行。安装上后发现网络异常，能上网，但是软件源是ping不通的，首先考虑的是dns问题，但其他网站又能ping通，非常诡异。我一天大概装了5次ubuntu21.04，被折磨的够呛。最后，生气了，22.04，下载，安装，搞定！  
现在想来，其实应该是软件源里没有21.04对应的资源，导致无法连接，也只是一个可能，我不太了解软件源是怎么构建的，也不想再安装一次21.04检查了，太痛苦了。选择linux发行版时还是尽量选择使用的人多的发行版，出现问题时找到解决方案的概率要更大一些。  
- - -
## 双系统共存  
我是在我自己的笔记本上安装的ubuntu，原先就安装了windows，因此安装ubuntu时首要目标就是保护windows的引导。我当时的想法是用windows的引导去选择ubuntu，结果被狠狠地打脸了。  
首先先说下我的储存设备，我的笔记本有1条128G的固态和1条1T的固态，windows装在1T的固态内，ubuntu装在128G固态内，都是GPT分区表，每条都有一个EFI分区(128G固态里的是之前装的windows遗留的引导分区)。因此想法是用EFI引导，结果发现，哈哈，微软的EFI不允许写入非windows引导，必须通过EasyUEFI这个软件来调整。但是，改动UEFI引导后依然无法看到启动时的系统选项，原因是我的两个系统引导都在我1T的固态的EFI分区里，在启动时这一块是交给BIOS控制的，真正应该修改的地方应该在BIOS里。我笔记本是老神舟，用的很老的那种bios，启动引导的选项就在选择启动设备的那一页最下面，bios可以根据EFI分区里的引导器选择哪种方式引导系统，将ubuntu改至第一位，终于能够看到grub的引导界面了。  
顺便提一嘴，貌似高版本的ubuntu增加了一个与windows共存的安装选项，会自己识别free space安装，引导写入windows的EFI中，不需要人为干预，挺方便的。我试了一下，如果手动划分区，把引导写入/boot的话，grub也是在windows的EFI分区里，和之前的步骤是一样的，而且我的128G固态上的EFI没有造成丝毫影响，就是划分区时不需要再划分EFI分区罢了。  
- - -
## 装软件
这个也是挺痛苦的一件事，因为我不只是要做PA，还想把现有的工作流搬到ubuntu上，因此得配自己的开发环境和常用的软件。ubuntu的应用商店其实已经非常健全，能提供大量的linux版软件，啊，除了QQ和微信(恼)。  
音乐我用的QQ音乐，因为我是绿钻，很搞的是官网下载的QQ音乐会闪退，应用商店那个unofficial的反而稳定的1b，据群友说那个其实就是官方版本。视频用的VLC，我windows里下载的视频都随便放，虽然没有potplayer好用就是了。QQ是最折腾人的，linux QQ依然是个残废，@人和回复直接消失，视频连消息都没有，只能看文字。wine版本的QQ充斥着闪退等问题，为了稳定还是选择忍着使用linux QQ。  
微信？狗都不用。汪  
我一般电脑旁边都放着平板和手机，有需要再点开，现在想想，ubuntu就相当于一个专注模式了，不让电脑上的其他东西干扰到自己，专心于自己的事，也挺好的。  
我是做硬件开发的，用的也就是C Python写点自动化脚本和小工具，剩下就是vivado了。Clion和Pycharm都可以在应用商店下到，vivado可以在官网直接下载，比windows版本要小了不少，再装个vscode，开发环境基本就配齐了。其实我的开发环境基本用不到ubuntu，啊，除了要调用PCIE的时候。  
不对，我笔记本用个锤子的PCIE  
扯远了，回到PA上，PA0要求装的工具全都可以直接sudo apt-get安装好，我折腾了一天只是因为我想把ubuntu打造成我的主力开发系统。除了llvm-11，这个只有ubuntu20.04需要安装，跳过就好。  
- - -
## 输入法
这个也是个蛋疼玩意。我直接装了个搜狗输入法，一定要注意，安装前把中文调到语言优先级第一，其实最好是安装时直接选中文，安装完后再修改显示语言就行。不然你的输入法死都跳不出来中文输入，极其弱智。PA建议你选择英文系统安装，其实不用，你在开始做实验前将语言调为英文就行，终端里的输出都会变成英文。
- - -
## GNU工具链
有一段要求你用vim写helloworld，用gcc和make编译，用gdb调试的，这个最好要认真做一下，我之前是调过vscode的运行与调试，这个用的还是蛮多的，就直接跳了。Makefile用的不多，我写的大工程要么是c，用cmakelist，要么是verilog，直接用对应ide编译就行。命令行工具虽然现在被包装在gui里了，但为了了解底层结构，还是看一下他是怎么实现的比较好，毕竟不想了解这些的也不会来做PA了。
- - -
## 编译NEMU
如果前面都走过来了，这里碰到的问题一定难不住你，其实就是缺失依赖的问题。我只记录我遇到的两个比较搞笑的问题。  
1. 切换至PA0分支后，直接运行make menuconfig会报错，Makefile line 3，目录不正确。其实是环境变量失效的问题，执行source ~/.bashrc重新激活环境变量即可。
2. 如果安装的llvm版本较高，比如我的是14.0，编译过程中还会报错，有一个头文件的位置与例程中的位置不一样了。  
```shell
src/utils/disasm.cc:5:10: fatal error: llvm/Support/TargetRegistry.h: No such file or directory  
```
已经有南大的同学提交了[issue](https://github.com/NJU-ProjectN/nemu/issues/16),在报错的disasm.cc中修改对应的#include即可。
```
- #include "llvm/Support/TargetRegistry.h"  
+ #include "llvm/MC/TargetRegistry.h"
```
这个问题之后还会遇到的。